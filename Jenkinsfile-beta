pipeline {
    agent any
    environment {
        GITHUB_PAT = credentials('tracer-pat')
        TMDB_API_KEY_FILE = credentials('tmdb_api_key_file')
    }
    
    stages {
        stage('Checkout') {
            steps {
                git url: 'https://github.com/arunkbabu90/PopMovies-and', branch: 'build/beta', credentialsId: GITHUB_PAT
            }
        }

        stage('Copy google-services.json file to app') {
            steps {
                script {
                    withCredentials([
                        file(credentialsId: 'POPMOVIES-GOOGLE-SERVICES-JSON', variable: 'GOOGLE_SERVICES_JSON')
                    ]) {
                        bat 'copy "%GOOGLE_SERVICES_JSON%" app\\google-services.json'
                    }
                }
            }
        }

        stage('Copy keystore.properties file to project Root') {
            steps {
                script {
                    withCredentials([
                        file(credentialsId: 'POPMOVIES_KEYSTORE_PROPERTIES_FILE', variable: 'APP_KEYSTORE_PROPERTIES_FILE')
                    ]) {
                        bat 'copy "%APP_KEYSTORE_PROPERTIES_FILE%" keystore.properties'
                    }
                }
            }
        }

        stage('Copy Keystore file to app') {
            steps {
                script {
                    withCredentials([
                        file(credentialsId: 'POPMOVIES_KEYSTORE_FILE', variable: 'APP_KEYSTORE_FILE')
                    ]) {
                        bat 'copy "%APP_KEYSTORE_FILE%" app\\Pop_Movies_v1.jks'
                    }
                }
            }
        }

        stage('Build Release AAB') {
            steps {
               script {
                    env.MovieDbApiKey = readFile(TMDB_API_KEY_FILE).trim()
               }
               sh './gradlew clean bundleRelease -PMovieDbApiKey=$MovieDbApiKey'
            }
        }

        stage('Publish APP to Google Play Store to Open Beta') {
            steps {
                script {
                    def recentChanges = readFile('release-notes.txt')

                    androidApkUpload googleCredentialsId: 'PLAY_CONSOLE_DEV_API_JSON_FILE',
                                     filesPattern: '**/app/build/outputs/bundle/release/*.aab',
                                     trackName: 'beta',
                                     inAppUpdatePriority: '2',
                                     rolloutPercentage: '100',
                                     recentChangeList: [
                                         [language: 'en-US', text: recentChanges]
                                     ]
                }
            }
        }
    }

    post {
        success {
            archiveArtifacts artifacts: '**/app/build/outputs/bundle/release/*.aab', allowEmptyArchive: true

            // Copy the artifacts to the specific directory
            script {
                def destinationDir = 'E:\\Outputs\\Android_Artifacts\\PopMovies\\beta'
                def appBundlePath = 'app\\build\\outputs\\bundle\\release\\'
                bat "copy ${appBundlePath} ${destinationDir}\\app"
            }
        }
    }
}
